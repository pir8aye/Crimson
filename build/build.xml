<?xml version="1.0"?>
<project name="Crimson" default="main" basedir=".">
	<property file="build/config/version.properties" />
	<property file="build/config/build.properties" />
	<tstamp>
		<format property="build.time" pattern="MM-dd-yyyy HH:mm:ss" locale="en,US" />
	</tstamp>

	<buildnumber file="build/build.number" />

	<target name="clean">
		<delete dir="${bin.dir}" />
		<delete dir="${dist.dir}" />
		<mkdir dir="${bin.dir}" />
		<mkdir dir="${dist.dir}" />
	</target>

	<target name="compile.proto" depends="clean">
		<description>Compile protocol buffers</description>
		<echo message="[BUILD] Compiling Protocol Buffers" />
		<apply executable="protoc" failonerror="true">
			<arg prefix="--java_out=" file="${src.dir}" />
			<arg prefix="--proto_path=" file="${proto.dir}" />
			<fileset dir="${proto.dir}">
				<include name="**/*.proto" />
			</fileset>
		</apply>
	</target>

	<target name="compile.java" depends="compile.proto">
		<description>Compile source</description>
		<echo message="[BUILD] Compiling source code" />
		<path id="class.path">
			<fileset dir="${lib.dir}/java">
				<include name="**/*.jar" />
			</fileset>
		</path>

		<javac includeantruntime="false" srcdir="${src.dir}" destdir="${bin.dir}" debug="true">
			<classpath refid="class.path" />
		</javac>
	</target>

	<!--Create jni files  -->
	<target name="jni" depends="compile.java">
		<javah destdir="${javah.dir}" verbose="yes" force="yes" classpath="${bin.dir}">
			<class name="com.subterranean_security.crimson.core.util.Native" />
		</javah>

		<exec executable="${script.dir}/jni-win.sh" />
		<exec executable="${script.dir}/jni-lin.sh" />
		<exec executable="${script.dir}/jni-osx.sh" />
	</target>

	<target name="copy-other" depends="jni">

		<!-- Copy misc files -->
		<copy todir="${bin.dir}">
			<fileset dir="${src.dir}">
				<exclude name="**/*.java" />
			</fileset>
		</copy>

	</target>

	<target name="jar.hcp" depends="copy-other">
		<description>Build hcp jar</description>
		<echo message="[BUILD] Building HCP library" />
		<jar destfile="${lib.dir}/java/c01.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/hcp/**" />
			</fileset>

			<manifest>
				<attribute name="CID" value="c01" />
				<attribute name="Main-Class" value="${hcp.main}" />
				<attribute name="Build-Number" value="${build.number}" />
				<attribute name="Crimson-Version" value="${crimson.version}" />
			</manifest>
		</jar>
	</target>

	<target name="jar.sc" depends="jar.hcp">
		<description>Build sc jar</description>
		<echo message="[BUILD] Building SC library" />
		<jar destfile="${lib.dir}/java/c02.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/sc/**" />
			</fileset>

			<manifest>
				<attribute name="CID" value="c02" />
			</manifest>
		</jar>
	</target>

	<target name="jar.sv" depends="jar.sc">
		<description>Build sv jar</description>
		<echo message="[BUILD] Building SV library" />
		<jar destfile="${lib.dir}/java/c03.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/sv/**" />
			</fileset>

			<manifest>
				<attribute name="CID" value="c03" />
			</manifest>
		</jar>
	</target>

	<target name="jar.cv" depends="jar.sv">
		<description>Build cv jar</description>
		<echo message="[BUILD] Building CV library" />
		<jar destfile="${lib.dir}/java/c04.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/cv/**" />
			</fileset>

			<manifest>
				<attribute name="CID" value="c04" />
			</manifest>
		</jar>
	</target>

	<target name="check.services">
		<available file="${bin.dir}/com/subterranean_security/services/Services.class" property="services.present" />
	</target>

	<target name="jar.services" depends="check.services,jar.cv" if="services.present">
		<description>Build services jar</description>
		<echo message="[BUILD] Building Services library" />
		<jar destfile="${lib.dir}/java/c05.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/services/**" />
			</fileset>

			<manifest>
				<attribute name="CID" value="c05" />
			</manifest>
		</jar>
	</target>

	<target name="jar.client" depends="jar.services">
		<description>Build client</description>
		<echo message="[BUILD] Building Client" />

		<!-- Generate class path -->
		<exec executable="scripts/resolve-cp.sh" outputproperty="client.cp">
			<arg value="C" />
		</exec>

		<jar destfile="${serverres.dir}/client.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/client/**" />
				<include name="**/com/subterranean_security/crimson/core/**" />
				<include name="**/com/subterranean_security/lapis/bin/**" />
			</fileset>

			<manifest>
				<attribute name="Main-Class" value="${client.main}" />
				<attribute name="Class-Path" value="${client.cp}" />
				<attribute name="Build-Number" value="${build.number}" />
				<attribute name="Crimson-Version" value="${crimson.version}" />
				<attribute name="Instance" value="Client" />
			</manifest>
		</jar>
	</target>

	<target name="jar.server" depends="jar.client">
		<description>Build server</description>
		<echo message="[BUILD] Building Server" />

		<!-- Generate class path -->
		<exec executable="scripts/resolve-cp.sh" outputproperty="server.cp">
			<arg value="S" />
		</exec>

		<jar destfile="${installres.dir}/Crimson-Server.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/server/**" />
				<include name="**/com/subterranean_security/crimson/core/**" />
			</fileset>

			<manifest>
				<attribute name="Main-Class" value="${server.main}" />
				<attribute name="Class-Path" value="${server.cp}" />
				<attribute name="Build-Time" value="${build.time}" />
				<attribute name="Build-Number" value="${build.number}" />
				<attribute name="Crimson-Version" value="${crimson.version}" />
				<attribute name="Application-Name" value="Crimson" />
				<attribute name="Instance" value="Server" />
			</manifest>
		</jar>
	</target>

	<target name="jar.viewer" depends="jar.server">
		<description>Build viewer</description>
		<echo message="[BUILD] Building Viewer" />

		<!-- Generate class path -->
		<exec executable="scripts/resolve-cp.sh" outputproperty="viewer.cp">
			<arg value="V" />
		</exec>

		<!-- Calculate file sizes -->
		<length file="${lib.dir}/java/c19.jar" property="jnativehook.size" />
		<length property="jni-win.size" mode="all">
			<fileset dir="${lib.dir}" includes="**/jni/win/**" />
		</length>
		<length property="jni-lin.size" mode="all">
			<fileset dir="${lib.dir}" includes="**/jni/lin/**" />
		</length>
		<length property="jni-osx.size" mode="all">
			<fileset dir="${lib.dir}" includes="**/jni/osx/**" />
		</length>
		<length property="jni-bsd.size" mode="all">
			<fileset dir="${lib.dir}" includes="**/jni/bsd/**" />
		</length>
		<length property="jni-sol.size" mode="all">
			<fileset dir="${lib.dir}" includes="**/jni/sol/**" />
		</length>
		<exec executable="scripts/resolve-lib-size.sh" outputproperty="client-lib.size">
		</exec>

		<jar destfile="${installres.dir}/Crimson-Viewer.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/crimson/viewer/**" />
				<include name="**/com/subterranean_security/crimson/core/**" />
			</fileset>

			<manifest>
				<attribute name="Main-Class" value="${viewer.main}" />
				<attribute name="Class-Path" value="${viewer.cp}" />
				<attribute name="Build-Time" value="${build.time}" />
				<attribute name="Build-Number" value="${build.number}" />
				<attribute name="Crimson-Version" value="${crimson.version}" />
				<attribute name="Application-Name" value="Crimson" />
				<attribute name="Instance" value="Viewer" />
				<attribute name="SplashScreen-Image" value="com/subterranean_security/crimson/viewer/ui/res/image/splash/splash.png" />

				<!-- File sizes -->
				<attribute name="jnativehook-size" value="${jnativehook.size}" />
				<attribute name="jni-win-size" value="${jni-win.size}" />
				<attribute name="jni-lin-size" value="${jni-lin.size}" />
				<attribute name="jni-osx-size" value="${jni-osx.size}" />
				<attribute name="jni-bsd-size" value="${jni-bsd.size}" />
				<attribute name="jni-sol-size" value="${jni-sol.size}" />
				<attribute name="client-lib-size" value="${client-lib.size}" />
			</manifest>
		</jar>
	</target>

	<target name="jar.cinstaller" depends="jar.viewer">
		<description>Build installer</description>
		<echo message="[BUILD] Building Installer" />

		<zip destfile="${installres.dir}/lib.zip" basedir="${lib.dir}" />

		<jar destfile="${dist.dir}/CInstaller.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/cinstaller/**" />
				<include name="**/com/subterranean_security/crimson/core/**" />
			</fileset>

			<manifest>
				<attribute name="Main-Class" value="${cinstaller.main}" />
				<attribute name="Build-Time" value="${build.time}" />
				<attribute name="Build-Number" value="${build.number}" />
				<attribute name="Crimson-Version" value="${crimson.version}" />
				<attribute name="SplashScreen-Image" value="com/subterranean_security/cinstaller/res/img/splash.png" />
			</manifest>
		</jar>
	</target>

	<target name="check.viridian">
		<available file="${bin.dir}/com/subterranean_security/viridian/Main.class" property="viridian.present" />
	</target>

	<target name="jar.viridian" depends="check.viridian,jar.cinstaller" if="viridian.present">
		<description>Build viridian</description>
		<echo message="[BUILD] Building Viridian" />

		<!-- Generate class path -->
		<exec executable="scripts/resolve-cp.sh" outputproperty="viridian.cp">
			<arg value="Q" />
		</exec>

		<jar destfile="${dist.dir}/Viridian.jar">
			<fileset dir="${bin.dir}">
				<include name="**/com/subterranean_security/viridian/**" />
				<include name="**/com/subterranean_security/crimson/core/**" />
			</fileset>

			<manifest>
				<attribute name="Main-Class" value="${viridian.main}" />
				<attribute name="Class-Path" value="${viridian.cp} ../../../usr/share/java/mysql.jar" />
				<attribute name="Build-Number" value="${build.number}" />
				<attribute name="Crimson-Version" value="${crimson.version}" />

			</manifest>
		</jar>
	</target>


	<target name="optimize" depends="jar.viridian">
		<description>Optimize</description>
		<echo message="[OPTIMIZE] Optimizing Jars" />

		<mkdir dir="${optimized.dir}" />
		<mkdir dir="${optimized.dir}/lib" />

		<taskdef resource="proguard/ant/task.properties" classpath="${project.dir}/build/lib/proguard.jar" />

		<proguard configuration="${project.dir}/build/config/proguard.conf" printmapping="/home/subterranean/codemap-${build.number}.txt">
			<injar name="${dist.dir}/Viridian.jar" />
			<injar name="${dist.dir}/CInstaller.jar" />
			<injar name="${installres.dir}/Crimson-Viewer.jar" />
			<injar name="${installres.dir}/Crimson-Server.jar" />
			<injar name="${serverres.dir}/client.jar" />
			<outjar name="${optimized.dir}" />

			<injar name="${lib.dir}/java/c01.jar" />
			<injar name="${lib.dir}/java/c02.jar" />
			<injar name="${lib.dir}/java/c03.jar" />
			<injar name="${lib.dir}/java/c04.jar" />
			<injar name="${lib.dir}/java/c05.jar" />
			<injar name="${lib.dir}/java/c06.jar" />
			<injar name="${lib.dir}/java/c07.jar" />
			<injar name="${lib.dir}/java/c08.jar" />
			<injar name="${lib.dir}/java/c09.jar" />
			<injar name="${lib.dir}/java/c10.jar" />
			<injar name="${lib.dir}/java/c11.jar" />
			<injar name="${lib.dir}/java/c12.jar" />
			<injar name="${lib.dir}/java/c13.jar" />
			<injar name="${lib.dir}/java/c14.jar" />
			<injar name="${lib.dir}/java/c15.jar" />
			<injar name="${lib.dir}/java/c16.jar" />
			<injar name="${lib.dir}/java/c17.jar" />
			<injar name="${lib.dir}/java/c18.jar" />
			<injar name="${lib.dir}/java/c19.jar" />
			<injar name="${lib.dir}/java/c20.jar" />
			<outjar name="${optimized.dir}/lib" />

			<libraryjar name="${java.home}/lib/rt.jar" />
		</proguard>

		<!-- Repopulate serverres with optimized jars -->
		<copy file="${optimized.dir}/client.jar" todir="${serverres.dir}" />

		<!-- Inject serverres -->
		<jar destfile="${optimized.dir}/Crimson-Server.jar" update="true">
			<zipfileset prefix="com/subterranean_security/crimson/server/res/bin/" dir="${serverres.dir}" />
		</jar>

		<!-- Repopulate installres with optimized jars -->
		<zip destfile="${installres.dir}/lib.zip" basedir="${optimized.dir}/lib" />
		<copy file="${optimized.dir}/Crimson-Server.jar" todir="${installres.dir}" />
		<copy file="${optimized.dir}/Crimson-Viewer.jar" todir="${installres.dir}" />

		<!-- Inject installres -->
		<jar destfile="${optimized.dir}/CInstaller.jar" update="true">
			<zipfileset prefix="com/subterranean_security/cinstaller/res/bin/" dir="${installres.dir}" />
		</jar>

		<copy file="${optimized.dir}/Viridian.jar" todir="${dist.dir}" />
		<copy file="${optimized.dir}/CInstaller.jar" todir="${dist.dir}" />

	</target>

	<target name="distribute" depends="jar.viridian">
		<description>Distribute</description>
		<echo message="[BUILD] Distributing results" />
		<copy file="${dist.dir}/Viridian.jar" todir="/srv/http/dist/" />
		<copy file="${dist.dir}/CInstaller.jar" todir="/srv/http/dist/" />
		<copy file="${bin.dir}/com/subterranean_security/cinstaller/res/bin/lib.zip" todir="/srv/http/dist/" />

	</target>

	<target name="main" depends="distribute">
		<description>Main target</description>
	</target>

</project>